<!DOCTYPE html>
<html>
<head>
    <title>Peer-to-Peer Walkie-Talkie</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            padding: 20px;
        }

        #status {
            margin-bottom: 10px;
        }

        #startButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #pttButton {
            padding: 50px;
            font-size: 24px;
            cursor: pointer;
            border-radius: 50%;
            background-color: lightgray;
        }

        #pttButton.disabled {
            background-color: #eee;
            cursor: default;
        }

        #remoteAudio {
            display: none; /* Hide audio element initially */
        }

        #roomIdInput{
          margin-bottom: 10px;
        }

    </style>
</head>
<body>
    <h1>Peer-to-Peer Walkie-Talkie</h1>
    <input type="text" id="roomIdInput" placeholder="Enter Room ID">
    <div id="status">Initializing...</div>
    <button id="startButton">Start Connection</button>
    <br><br>
    <button id="pttButton" disabled>Push to Talk</button>
    <audio id="remoteAudio" autoplay></audio>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const statusDiv = document.getElementById('status');
        const startButton = document.getElementById('startButton');
        const pttButton = document.getElementById('pttButton');
        const remoteAudio = document.getElementById('remoteAudio');
        const roomIdInput = document.getElementById('roomIdInput');

        let peerConnection;
        let localStream;
        let remoteStream;
        let socket;
        let roomId;

        startButton.addEventListener('click', startConnection);
        pttButton.addEventListener('mousedown', startTalking);
        pttButton.addEventListener('mouseup', stopTalking);

        async function startConnection() {
            try {
                roomId = roomIdInput.value.trim();
                if (!roomId) {
                    statusDiv.textContent = "Please enter a Room ID.";
                    return;
                }

                statusDiv.textContent = 'Requesting media access...';
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                statusDiv.textContent = 'Connecting to signaling server...';
                socket = io('https://socket-io-chat-h9jt.onrender.com'); // Using a publicly available server.

                socket.on('connect', () => {
                    statusDiv.textContent = 'Connected to signaling server. Joining room...';
                    socket.emit('join', roomId);
                });

                socket.on('joined', (room) => {
                    statusDiv.textContent = `Joined room: ${room}`;
                    initializePeerConnection();
                });

                socket.on('offer', async (offer) => {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    socket.emit('answer', { answer, roomId });
                });

                socket.on('answer', async (answer) => {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                });

                socket.on('ice-candidate', async (candidate) => {
                    try{
                        await peerConnection.addIceCandidate(candidate);
                    } catch (e){
                        console.error('Error adding ice candidate', e);
                    }
                });

                startButton.disabled = true;
                pttButton.disabled = false;
                statusDiv.textContent = 'Ready to talk!';

            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
                console.error('Error starting connection:', error);
            }
        }

        function initializePeerConnection() {
            peerConnection = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', { candidate: event.candidate, roomId });
                }
            };

            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                remoteAudio.srcObject = remoteStream;
            };

            peerConnection.oniceconnectionstatechange = () => {
                statusDiv.textContent = `Connection state: ${peerConnection.iceConnectionState}`;
                if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'closed') {
                    startButton.disabled = false;
                    pttButton.disabled = true;
                }
            };

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            if (socket.id) {
                socket.emit('offer', {
                    offer: peerConnection.createOffer()
                        .then(offer => peerConnection.setLocalDescription(offer))
                        .then(() => peerConnection.localDescription),
                    roomId: roomId
                });
            }
        }

        function startTalking() {
            console.log('Talking...');
        }

        function stopTalking() {
            console.log('Stopped talking.');
        }

    </script>
</body>
</html>

